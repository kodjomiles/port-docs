import GitLabActionModificationHint from './\_gitlab_action_modification_required_hint.mdx'
import GitLabDedicatedRepoHint from './\_gitlab_dedicated_ci_pipeline_repository_hint.mdx'
import PagerDutyIncidentBlueprint from './blueprints/_pagerduty_incident_blueprint.mdx'

# Trigger A PagerDuty Incident GitLab CI Pipeline

## Overview
This self-service guide provides a detailed walkthrough on how to trigger an incident in PagerDuty from Port using Port's self-service actions configured with GitLab CI.

## Prerequisites
1. [GitLab CI/CD environment](https://docs.gitlab.com/ee/ci/quick_start) should be set up.
2. In your GitLab repository, [go to **Settings > CI/CD**](https://docs.gitlab.com/ee/ci/variables/#define-a-cicd-variable-in-the-ui) and add the following secrets:
   - `PAGERDUTY_API_KEY` - [PagerDuty API token](https://support.pagerduty.com/docs/generating-api-keys) generated by the user.
   - `PORT_CLIENT_ID` - Your port `client id` [How to get the credentials](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/api/#find-your-port-credentials).
   - `PORT_CLIENT_SECRET` - Your port `client secret` [How to get the credentials](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/api/#find-your-port-credentials).
3. Optional - Install Port's PagerDuty integration [learn more](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/incident-management/pagerduty)

	:::tip PagerDuty Integration
	This step is not required for this example, but it will create all the blueprint boilerplate for you, and also ingest and update the catalog in real time with your PagerDuty Incidents.
	:::

4. In case you decided not to install the PagerDuty integration, you will need to create a blueprint for PagerDuty incidents in Port.
   <br />
   <img src='/img/self-service-actions/setup-backend/gitlab-pipeline/addingBlueprint.png' width='85%' border="1px" />

<PagerDutyIncidentBlueprint/>

## GitLab CI Pipeline

Create the file `.gitlab-ci.yml` in the `root` of your repository with the following content:

<GitLabDedicatedRepoHint/>

<details>
<summary><b>GitLab CI Pipeline</b></summary>

```yaml showLineNumbers title="gitlab-ci.yaml"
stages:
  - trigger_incident

variables:
  PAGERDUTY_API_KEY: $PAGERDUTY_API_KEY
  PORT_CLIENT_ID: $PORT_CLIENT_ID
  PORT_CLIENT_SECRET: $PORT_CLIENT_SECRET
  PORT_BASE_URL: "https://api.getport.io/v1"

trigger_incident_job:
  stage: trigger_incident
  before_script:
    - apt-get update && apt-get install -y jq
  script:
    - |
      set -e

      report_to_port() {
        local message=$1
        curl -X POST -s \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -d '{"message":"'"$message"'"}' \
          "${PORT_BASE_URL}/actions/runs/$RUN_ID/logs"
      }

      failure() {
        report_to_port "CI job failed. Please check the logs for more details."
        curl -X PATCH -s \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -d '{"status":"FAILURE"}' \
          "${PORT_BASE_URL}/actions/runs/$RUN_ID"
        exit 1
      }

      trap 'failure' ERR

      payload=$(cat $TRIGGER_PAYLOAD)

      PAYLOAD_SUMMARY=$(echo $payload | jq -r '.summary')
      PAYLOAD_SOURCE=$(echo $payload | jq -r '.source')
      PAYLOAD_SEVERITY=$(echo $payload | jq -r '.severity')
      EVENT_ACTION=$(echo $payload | jq -r '.event_action')
      ROUTING_KEY=$(echo $payload | jq -r '.routing_key')
      PORT_CONTEXT_BLUEPRINT=$(echo $payload | jq -r '.port_context.blueprint')
      PORT_CONTEXT_ENTITY=$(echo $payload | jq -r '.port_context.entity')
      PORT_CONTEXT_RUN_ID=$(echo $payload | jq -r '.port_context.run_id')
      PORT_CONTEXT_RELATIONS=$(echo $payload | jq -r '.port_context.relations')

      report_to_port "Getting access token from Port API."
      ACCESS_TOKEN=$(curl -X POST -s \
        -H 'Content-Type: application/json' \
        -d '{"clientId": "'"$PORT_CLIENT_ID"'", "clientSecret": "'"$PORT_CLIENT_SECRET"'"}' \
        'https://api.getport.io/v1/auth/access_token' | jq -r '.accessToken')

      if [ -z "$ACCESS_TOKEN" ]; then
        report_to_port "Failed to get access token from Port API."
        exit 1
      fi

      RUN_ID=$PORT_CONTEXT_RUN_ID

      report_to_port "About to trigger PagerDuty incident.. ⛴️"

      curl -X PATCH -s \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -d '{"link":"'"$CI_PIPELINE_URL"'"}' \
        "${PORT_BASE_URL}/actions/runs/$RUN_ID"

      pagerduty_response=$(curl -X POST -s \
        -H "Content-Type: application/json" \
        -H "Accept: application/json" \
        -d '{
              "payload": {
                "summary": "'"${PAYLOAD_SUMMARY}"'",
                "source": "'"${PAYLOAD_SOURCE}"'",
                "severity": "'"${PAYLOAD_SEVERITY}"'"
              },
              "event_action": "'"${EVENT_ACTION}"'",
              "routing_key": "'"${ROUTING_KEY}"'"
            }' \
        https://events.pagerduty.com/v2/enqueue)

      report_to_port "PagerDuty response: $pagerduty_response"

      incident_id=$(echo $pagerduty_response | jq -r '.dedup_key')
      if [ "$incident_id" == "null" ]; then
        report_to_port "Failed to get incident ID from PagerDuty response."
        exit 1
      fi

      incident_details=$(curl -X GET -s \
        -H "Content-Type: application/json" \
        -H "Accept: application/vnd.pagerduty+json;version=2" \
        -H "Authorization: Token token=${PAGERDUTY_API_KEY}" \
        https://api.pagerduty.com/incidents/$incident_id)


      curl -X PATCH -s \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -d '{
              "identifier": "'"${incident_id}"'",
              "title": "'"$(echo $incident_details | jq -r '.incident.title')"'",
              "team": "[]",
              "icon": "pagerduty",
              "blueprint": "'"${PORT_CONTEXT_BLUEPRINT}"'",
              "properties": {
                "status": "'"$(echo $incident_details | jq -r '.incident.status')"'",
                "url": "'"$(echo $incident_details | jq -r '.incident.self')"'",
                "urgency": "'"$(echo $incident_details | jq -r '.incident.urgency')"'",
                "responder": "'"$(echo $incident_details | jq -r '.incident.assignments[0].assignee.summary')"'",
                "escalation_policy": "'"$(echo $incident_details | jq -r '.incident.escalation_policy.summary')"'",
                "created_at": "'"$(echo $incident_details | jq -r '.incident.created_at')"'",
                "updated_at": "'"$(echo $incident_details | jq -r '.incident.updated_at')"'"
              },
              "relations": "'"${PORT_CONTEXT_RELATIONS}"'",
              "operation": "UPSERT",
              "runId": "'"${RUN_ID}"'"
            }' \
        "${PORT_BASE_URL}/entities"

      report_to_port "PagerDuty incident triggered! ✅"

      curl -X PATCH -s \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -d '{"status":"SUCCESS"}' \
        "${PORT_BASE_URL}/actions/runs/$RUN_ID"

```
</details>


## Port Configuration

Create a new self service action using the following JSON configuration.
<br />
<img src='/img/self-service-actions/setup-backend/gitlab-pipeline/createNewSelfServiceAction.png' width='85%' border="1px" />

<details>
<summary><b> Trigger Incident In PagerDuty (click to expand) Gitlab </b></summary>

<GitLabActionModificationHint/>

```json showLineNumbers
{
  "identifier": "pagerdutyIncident_trigger_incident_gitlab",
  "title": "Trigger Incident Gitlab",
  "icon": "pagerduty",
  "description": "Trigger a PagerDuty incident using self-service",
  "trigger": {
    "type": "self-service",
    "operation": "DAY-2",
    "userInputs": {
      "properties": {
        "event_action": {
          "icon": "pagerduty",
          "title": "Event Action",
          "type": "string",
          "description": "The type of event. Can be trigger, acknowledge, or resolve",
          "default": "trigger",
          "enum": [
            "trigger",
            "acknowledge",
            "resolve"
          ],
          "enumColors": {
            "trigger": "lightGray",
            "acknowledge": "lightGray",
            "resolve": "lightGray"
          }
        },
        "routing_key": {
          "icon": "pagerduty",
          "title": "Routing Key",
          "type": "string",
          "description": "This is the 32 character Integration Key for an integration on a service or on a global ruleset."
        },
        "summary": {
          "type": "string",
          "title": "Summary",
          "icon": "pagerduty",
          "description": "A brief text summary of the event, used to generate the summaries/titles of any associated alerts. The maximum permitted length of this property is 1024 characters.",
          "maxLength": 1024
        },
        "source": {
          "type": "string",
          "title": "Source",
          "description": "The unique location of the affected system, preferably a hostname or FQDN.",
          "icon": "pagerduty"
        },
        "severity": {
          "type": "string",
          "title": "Severity",
          "description": "The perceived severity of the status the event is describing with respect to the affected system. This can be critical, error, warning, or info",
          "icon": "pagerduty",
          "default": "info",
          "enum": [
            "critical",
            "error",
            "warning",
            "info"
          ],
          "enumColors": {
            "critical": "red",
            "error": "orange",
            "warning": "yellow",
            "info": "blue"
          }
        }
      },
      "required": [
        "routing_key",
        "event_action",
        "summary",
        "source",
        "severity"
      ],
      "order": [
        "routing_key",
        "event_action",
        "summary",
        "source",
        "severity"
      ]
    },
    "blueprintIdentifier": "pagerdutyIncident"
  },
  "invocationMethod": {
    "type": "WEBHOOK",
    "url": "https://gitlab.com/api/v4/projects/<YOUR_PROJECT_ID>/ref/main/trigger/pipeline?token=<YOUR_TRIGGER_TOKEN>",
    "agent": false,
    "synchronized": false,
    "method": "POST",
    "body": {
      "summary": "{{.inputs.\"summary\"}}",
      "source": "{{.inputs.\"source\"}}",
      "severity": "{{.inputs.\"severity\"}}",
      "event_action": "{{.inputs.\"event_action\"}}",
      "routing_key": "{{.inputs.\"routing_key\"}}",
      "port_context": {
        "blueprint": "{{.action.blueprint}}",
        "entity": "{{.entity.identifier}}",
        "run_id": "{{.run.id}}",
        "relations": "{{.entity.relations}}"
      }
    }
  },
  "requiredApproval": false,
  "publish": true
}
```
</details>

Now you should see the `Trigger Incidents Gitlab` action in the self-service page. 🎉
<br />
<img src='/img/self-service-actions/setup-backend/gitlab-pipeline/triggerGitlabIncident.png' width='85%' border="1px" />

## Let's test it!

1. Head to the [Self Service hub](https://app.getport.io/self-serve)
2. Click on the `Trigger Incident Gitlab` action
3. Choose the pagerduty incident you want to trigger (In case you didn't install the [PagerDuty integration](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/incident-management/pagerduty), it means you don't have any PagerDuty incidents in Port yet, so you will need to create one manually in Port to test this action)
4. Click on `Execute`
5. Fill the fields in the form
6. Click on `Execute`
7. Done! wait for the incident's status to be changed in PagerDuty
<br />
<img src='/img/self-service-actions/setup-backend/gitlab-pipeline/successTriggerGitlabIncident.png' width='85%' border="1px" />

Congrats 🎉 You've triggered a PagerDuty incident in Port 🔥

## More Self Service PagerDuty Actions Examples
- [Acknowledge Incident](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/acknowledge-incident)
- [Change On-Call User](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/change-on-call-user)
- [Change PagerDuty incident owner](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/change-pagerduty-incident-owner)
- [Create PagerDuty incident](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/create-pagerduty-incident)
- [Create PagerDuty service](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/create-pagerduty-service)
- [Escalate an incident](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/escalate-an-incident)
- [Resolve an incident](https://docs.getport.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/resolve-incident)
